# Static and Media Files Configuration

This document explains how static and media files are handled in HandyGH for both development and production environments.

## Overview

- **Static Files**: CSS, JavaScript, images, and other assets that are part of the application
- **Media Files**: User-uploaded content (profile pictures, verification documents, dispute evidence)

## Development Environment

### Configuration

In development (`handygh/settings/development.py`):
- Static files are served by Django's development server
- `STATIC_URL = '/static/'`
- `STATIC_ROOT = BASE_DIR / 'staticfiles'`
- `STATICFILES_DIRS = [BASE_DIR / 'static']`
- `MEDIA_URL = '/media/'`
- `MEDIA_ROOT = BASE_DIR / 'media'`

### Usage

1. Place static files in `backend/static/` directory
2. Run `python manage.py collectstatic` to collect files (optional in dev)
3. Access static files at `http://localhost:8000/static/`
4. Access media files at `http://localhost:8000/media/`

## Production Environment

### Configuration

In production (`handygh/settings/production.py`):
- Static files are served by **Whitenoise** (compressed and cached)
- Media files are served by **Nginx** (or cloud storage like S3)
- `STATIC_ROOT = /opt/handygh/backend/staticfiles`
- `MEDIA_ROOT = /opt/handygh/backend/media`

### Whitenoise Configuration

Whitenoise is configured in production settings:

```python
MIDDLEWARE.insert(1, "whitenoise.middleware.WhiteNoiseMiddleware")
STORAGES = {
    "staticfiles": {
        "BACKEND": "whitenoise.storage.CompressedManifestStaticFilesStorage",
    },
}
```

Benefits:
- Automatic compression (gzip/brotli)
- Cache-friendly file names with content hashes
- Far-future cache headers
- No need for separate CDN for static files (though recommended for scale)

### Collecting Static Files

Before deployment, collect all static files:

```bash
# Using the provided script
cd backend/deployment
chmod +x collect_static.sh
./collect_static.sh

# Or manually
cd backend
python manage.py collectstatic --noinput --clear
```

This will:
1. Collect all static files from apps and `STATICFILES_DIRS`
2. Process them with Whitenoise (compression, hashing)
3. Place them in `staticfiles/` directory

### Nginx Configuration

Nginx serves media files and proxies API requests to Gunicorn:

```nginx
# Static files (served by Whitenoise through Gunicorn)
location /static/ {
    alias /opt/handygh/backend/staticfiles/;
    expires 30d;
    add_header Cache-Control "public, immutable";
}

# Media files (served directly by Nginx)
location /media/ {
    alias /opt/handygh/backend/media/;
    expires 7d;
    add_header Cache-Control "public";
}
```

## File Upload Security

### Size Limits

Configured in production settings:
- `FILE_UPLOAD_MAX_MEMORY_SIZE = 5242880` (5MB)
- `DATA_UPLOAD_MAX_MEMORY_SIZE = 5242880` (5MB)

Also configured in Nginx:
- `client_max_body_size 5M;`

### Permissions

Files are created with secure permissions:
- `FILE_UPLOAD_PERMISSIONS = 0o644` (rw-r--r--)
- `FILE_UPLOAD_DIRECTORY_PERMISSIONS = 0o755` (rwxr-xr-x)

### Allowed File Types

For user uploads (profile pictures, documents):
- Images: JPEG, PNG, WebP
- Documents: PDF
- Maximum size: 5MB

Validation is performed in serializers and views.

## Cloud Storage (Future Enhancement)

For production at scale, consider using cloud storage:

### AWS S3 Configuration

```python
# settings/production.py
STORAGES = {
    "default": {
        "BACKEND": "storages.backends.s3boto3.S3Boto3Storage",
        "OPTIONS": {
            "access_key": config("AWS_ACCESS_KEY_ID"),
            "secret_key": config("AWS_SECRET_ACCESS_KEY"),
            "bucket_name": config("AWS_STORAGE_BUCKET_NAME"),
            "region_name": config("AWS_S3_REGION_NAME"),
            "default_acl": "private",
            "file_overwrite": False,
        },
    },
    "staticfiles": {
        "BACKEND": "whitenoise.storage.CompressedManifestStaticFilesStorage",
    },
}
```

Required packages:
```bash
pip install django-storages boto3
```

Benefits:
- Scalable storage
- CDN integration (CloudFront)
- Automatic backups
- Reduced server load

## Directory Structure

```
backend/
├── static/                 # Source static files (committed to git)
│   ├── css/
│   ├── js/
│   └── images/
├── staticfiles/           # Collected static files (not in git)
│   └── (generated by collectstatic)
├── media/                 # User uploads (not in git)
│   ├── profiles/
│   ├── documents/
│   └── disputes/
└── deployment/
    ├── collect_static.sh  # Static collection script
    └── nginx.conf         # Nginx configuration
```

## Deployment Checklist

- [ ] Run `collectstatic` before deployment
- [ ] Ensure `staticfiles/` directory exists and has proper permissions
- [ ] Ensure `media/` directory exists and has proper permissions
- [ ] Configure Nginx to serve static and media files
- [ ] Set up SSL certificates for HTTPS
- [ ] Configure proper cache headers
- [ ] Test file uploads work correctly
- [ ] Verify static files load with correct URLs
- [ ] Set up backup strategy for media files

## Troubleshooting

### Static files not loading

1. Check `STATIC_ROOT` and `STATIC_URL` settings
2. Run `collectstatic` again
3. Check Nginx configuration and restart: `sudo systemctl restart nginx`
4. Check file permissions: `ls -la staticfiles/`
5. Check browser console for 404 errors

### Media files not accessible

1. Check `MEDIA_ROOT` and `MEDIA_URL` settings
2. Check Nginx configuration for `/media/` location
3. Check file permissions: `ls -la media/`
4. Ensure directory exists: `mkdir -p media`

### File upload fails

1. Check file size limits in settings and Nginx
2. Check disk space: `df -h`
3. Check directory permissions: `ls -ld media/`
4. Check Django logs for validation errors

### Whitenoise not compressing files

1. Ensure `DEBUG = False` in production
2. Check middleware order (WhiteNoiseMiddleware should be early)
3. Run `collectstatic` with `--clear` flag
4. Check for errors in collectstatic output

## Performance Optimization

### Static Files

1. Use Whitenoise compression (enabled by default)
2. Set far-future cache headers (configured in Nginx)
3. Consider CDN for global distribution
4. Minimize and bundle CSS/JS files

### Media Files

1. Optimize images before upload (client-side)
2. Use appropriate image formats (WebP for photos)
3. Implement lazy loading for images
4. Consider image processing service (Cloudinary, Imgix)
5. Set up regular cleanup of unused files

## Backup Strategy

### Media Files Backup

```bash
# Daily backup script
#!/bin/bash
BACKUP_DIR="/backups/handygh/media"
DATE=$(date +%Y%m%d)
tar -czf "$BACKUP_DIR/media_$DATE.tar.gz" /opt/handygh/backend/media/

# Keep only last 30 days
find "$BACKUP_DIR" -name "media_*.tar.gz" -mtime +30 -delete
```

Add to crontab:
```
0 2 * * * /opt/handygh/scripts/backup_media.sh
```

### Cloud Storage Backup

If using S3, enable versioning and lifecycle policies:
- Enable versioning for accidental deletion recovery
- Set lifecycle policy to move old versions to Glacier
- Enable cross-region replication for disaster recovery

## Monitoring

Monitor these metrics:
- Disk usage for media files
- Static file cache hit rate
- File upload success/failure rate
- Average file upload time
- Storage costs (if using cloud)

## References

- [Django Static Files Documentation](https://docs.djangoproject.com/en/4.2/howto/static-files/)
- [Whitenoise Documentation](http://whitenoise.evans.io/)
- [Django Storages Documentation](https://django-storages.readthedocs.io/)
- [Nginx Static Files Best Practices](https://www.nginx.com/blog/nginx-caching-guide/)
