generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  role          Role     @default(CUSTOMER)
  name          String?
  email         String?  @unique(map: "users_email_key") // ✅ keep unique index but nullable
  phone         String   @unique
  password_hash String?
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  provider      Provider?
  bookingsAsCustomer Booking[] @relation("CustomerBookings")
  reviews       Review[]
  refreshTokens RefreshToken[]

  @@map("users")
}

model Provider {
  id                 String    @id @default(cuid())
  user_id            String    @unique
  business_name      String?
  categories         String[]
  latitude           Float?
  longitude          Float?
  address            String?
  verified           Boolean   @default(false)
  verification_doc_url String?
  rating_avg         Decimal   @default("0") @db.Decimal(3,2) // ✅ fixed default
  rating_count       Int       @default(0)
  created_at         DateTime  @default(now())

  user               User      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  services           ProviderService[]
  bookings           Booking[]
  reviews            Review[]

  @@map("providers")
}

model ProviderService {
  id               String    @id @default(cuid())
  provider_id      String
  title            String
  description      String?
  price_type       PriceType
  price_amount     Decimal   @db.Decimal(12,2)
  duration_minutes Int?
  is_active        Boolean   @default(true)
  created_at       DateTime  @default(now())

  provider         Provider  @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  bookings         Booking[]

  @@map("provider_services")
}

model Booking {
  id                  String        @id @default(cuid())
  booking_ref         String        @unique
  customer_id         String
  provider_id         String
  provider_service_id String
  status              BookingStatus @default(REQUESTED)
  scheduled_start     DateTime
  scheduled_end       DateTime?
  address             String
  total_amount        Decimal       @db.Decimal(12,2)
  commission_amount   Decimal?      @db.Decimal(12,2)
  payment_status      PaymentStatus @default(PENDING)
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  customer            User          @relation("CustomerBookings", fields: [customer_id], references: [id])
  provider            Provider      @relation(fields: [provider_id], references: [id])
  providerService     ProviderService @relation(fields: [provider_service_id], references: [id])
  transactions        Transaction[]
  messages            Message[]
  review              Review?
  dispute             Dispute?

  @@map("bookings")
}

model Transaction {
  id           String            @id @default(cuid())
  booking_id   String
  txn_provider String?
  payer_id     String?
  payee_id     String?
  amount       Decimal           @db.Decimal(12,2)
  currency     String            @default("GHS")
  status       TransactionStatus @default(INITIATED)
  metadata     Json?
  created_at   DateTime          @default(now())
  updated_at   DateTime          @updatedAt // ✅ added for consistency

  booking      Booking           @relation(fields: [booking_id], references: [id])

  @@map("transactions")
}

model Review {
  id         String   @id @default(cuid())
  booking_id String   @unique
  customer_id String
  provider_id String
  rating     Int      @db.SmallInt
  comment    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt // ✅ added for consistency

  booking    Booking  @relation(fields: [booking_id], references: [id])
  customer   User     @relation(fields: [customer_id], references: [id])
  provider   Provider @relation(fields: [provider_id], references: [id])

  @@map("reviews")
}

model Message {
  id         String   @id @default(cuid())
  booking_id String
  sender_id  String
  content    String
  attachments String[]
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt // ✅ added for consistency

  booking    Booking  @relation(fields: [booking_id], references: [id])

  @@map("messages")
}

model Dispute {
  id          String        @id @default(cuid())
  booking_id  String        @unique
  reason      String
  description String
  evidence    String[]
  status      DisputeStatus @default(OPEN)
  resolution  String?
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  booking     Booking       @relation(fields: [booking_id], references: [id])

  @@map("disputes")
}

model RefreshToken {
  id         String   @id @default(cuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())

  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

enum Role {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum PriceType {
  HOURLY
  FIXED
}

enum BookingStatus {
  REQUESTED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum TransactionStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum DisputeStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}
